---
import { API_URL, DEFAULT_COMPANY, DEFAULT_USER } from "../../consts";
import type { LoginPayload } from "../../services/auth";
import { fetchProfile, login } from "../../services/auth";

const loginEndpoint = `${API_URL}/users/login`;
const profileEndpoint = `${API_URL}/users/me`;
---

<section class="card-surface p-8 space-y-6">
  <header class="space-y-2">
    <div class="inline-flex items-center gap-2 rounded-full bg-primary/10 px-3 py-1 text-primary text-sm font-semibold">
      Acceso seguro
      <span class="badge bg-primary/10 text-primary">FastAPI + Supabase</span>
    </div>
    <h2 class="text-2xl font-bold text-ink">Ingresá a IsoTrack</h2>
    <p class="text-slate-600 text-sm">
      Autenticación basada en Supabase con FastAPI. La sesión se vincula a la empresa {DEFAULT_COMPANY.name}.
    </p>
  </header>

  <form id="login-form" class="space-y-4" data-endpoint={loginEndpoint} data-profile-endpoint={profileEndpoint}>
    <div class="space-y-1">
      <label class="form-label" for="email">Correo electrónico</label>
      <input
        class="form-input"
        id="email"
        name="email"
        type="email"
        value={DEFAULT_USER.email}
        autocomplete="username"
        required
        placeholder="usuario@empresa.com"
      />
    </div>
    <div class="space-y-1">
      <label class="form-label" for="password">Contraseña</label>
      <input
        class="form-input"
        id="password"
        name="password"
        type="password"
        autocomplete="current-password"
        required
        placeholder="••••••••"
      />
      <p class="text-xs text-slate-500">Tu contraseña se valida en FastAPI contra Supabase Auth.</p>
    </div>
    <button class="button-primary w-full" type="submit" id="login-submit">
      Iniciar sesión
    </button>
    <p id="login-status" class="text-sm text-slate-600"></p>
    <pre
      id="login-preview"
      class="hidden text-xs bg-slate-900 text-white p-4 rounded-xl overflow-x-auto border border-slate-800"
    ></pre>
  </form>
</section>

<script type="module">
  import { fetchProfile, login } from "../../services/auth";

  const PROFILE_STORAGE_KEY = "profile";
  const ACCESS_TOKEN_KEY = "accessToken";
  const REFRESH_TOKEN_KEY = "refreshToken";

  const form = document.querySelector<HTMLFormElement>("#login-form");
  const status = document.querySelector<HTMLParagraphElement>("#login-status");
  const preview = document.querySelector<HTMLPreElement>("#login-preview");
  const submit = document.querySelector<HTMLButtonElement>("#login-submit");

  const emitLogin = (detail) => {
    window.dispatchEvent(new CustomEvent("session:login", { detail }));
  };

  async function persistProfile(accessToken, endpoint) {
    if (!accessToken || !endpoint) return;
    try {
      const profileResponse = await fetchProfile(endpoint, accessToken);
      localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profileResponse.data));
      emitLogin({ profile: profileResponse.data, accessToken });
    } catch (error) {
      console.error("No se pudo obtener el perfil", error);
    }
  }

  async function handleSubmit(event) {
    event.preventDefault();
    if (!form || !status || !submit) return;

    const endpoint = form.dataset.endpoint;
    const profileEndpoint = form.dataset.profileEndpoint;
    if (!endpoint) {
      status.textContent = "No se configuró el endpoint de login";
      status.classList.add("text-red-600");
      return;
    }

    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    submit.disabled = true;
    status.textContent = "Conectando con FastAPI...";
    status.className = "text-sm text-slate-600";

    try {
      const response = await login(endpoint, payload as unknown as LoginPayload);
      status.textContent = response.message || "Login exitoso";
      status.className = "text-sm text-emerald-600 font-semibold";

      if (response.success && response.data) {
        localStorage.setItem(ACCESS_TOKEN_KEY, response.data.accessToken);
        localStorage.setItem(REFRESH_TOKEN_KEY, response.data.refresh_token);
        localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(response.data.profile));

        emitLogin({ profile: response.data.profile, accessToken: response.data.accessToken });
        await persistProfile(response.data.accessToken, profileEndpoint);

        if (preview) {
          preview.textContent = JSON.stringify(response.data, null, 2);
          preview.classList.remove("hidden");
        }
      }
    } catch (error) {
      const message = error instanceof Error ? error.message : "No se pudo iniciar sesión";
      status.textContent = message;
      status.className = "text-sm text-red-600 font-semibold";
    } finally {
      submit.disabled = false;
    }
  }

  form?.addEventListener("submit", handleSubmit);
</script>
