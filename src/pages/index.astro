---
import Layout from "../layouts/Layout.astro";
import LoginForm from "../components/auth/LoginForm";
import { API_URL, DEFAULT_COMPANY, SUPABASE_URL } from "../consts";

const profileEndpoint = `${API_URL}/users/me`;
const logoutEndpoint = `${API_URL}/users/logout`;
const documentsEndpoint = `${API_URL}/documents`;
---

<Layout
  title="IsoTrack ¬∑ Fase 1.3"
  description="Autenticaci√≥n obligatoria, bienvenida y listado inicial de documentos"
>
  <div class="grid gap-8 xl:grid-cols-[1.1fr_0.9fr] items-start">
    <section
      id="protected-area"
      class="card-surface p-8 space-y-6 relative overflow-hidden"
      data-profile-endpoint={profileEndpoint}
      data-logout-endpoint={logoutEndpoint}
      data-documents-endpoint={documentsEndpoint}
    >
      <div
        id="lock-overlay"
        class="absolute inset-0 bg-white/80 backdrop-blur-sm border border-dashed border-slate-200 flex flex-col items-center justify-center gap-3 text-center"
        role="presentation"
      >
        <p class="text-sm text-slate-600">Debes iniciar sesi√≥n para ver la informaci√≥n de la empresa</p>
        <p class="text-xs text-slate-500">Sin registro disponible ¬∑ Usa las credenciales provistas</p>
      </div>

      <header class="space-y-3">
        <p class="badge bg-primary/10 text-primary">Astro + Radix ¬∑ Auth requerida</p>
        <h1 class="text-3xl font-bold text-ink">Fase 1.3 ¬∑ Bienvenida + documentos</h1>
        <p class="text-slate-600">
          El usuario comienza en <span class="font-semibold">/login</span> y, tras autenticarse, vuelve aqu√≠ para ver su bienvenida y
          el primer listado protegido de documentos de la empresa.
        </p>
      </header>

      <div class="flex items-center justify-end">
        <button id="logout-button" class="button-secondary" type="button">Cerrar sesi√≥n</button>
      </div>

      <div class="grid sm:grid-cols-2 gap-4" id="locked-content">
        <div class="card-surface p-5 space-y-2">
          <p class="text-sm text-slate-500">Empresa activa</p>
          <p class="font-semibold text-lg">{DEFAULT_COMPANY.name}</p>
          <p class="text-xs text-slate-500">{DEFAULT_COMPANY.id}</p>
        </div>
        <div class="card-surface p-5 space-y-2">
          <p class="text-sm text-slate-500">Supabase URL</p>
          <p class="font-semibold break-all text-primary">{SUPABASE_URL}</p>
          <p class="text-xs text-slate-500">Configurable por entorno VITE/PUBLIC.</p>
        </div>
        <div class="card-surface p-5 space-y-3 sm:col-span-2" id="profile-card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Usuario autenticado</p>
              <p id="profile-name" class="font-semibold text-lg">Pendiente de autenticaci√≥n</p>
              <p id="profile-email" class="text-xs text-slate-500">---</p>
            </div>
            <span class="badge bg-emerald-100 text-emerald-700" id="profile-role">Sin sesi√≥n</span>
          </div>
          <div class="grid sm:grid-cols-3 gap-3 text-sm text-slate-600" id="profile-meta">
            <div>
              <p class="text-xs uppercase text-slate-500">Company ID</p>
              <p id="profile-company">‚Äî</p>
            </div>
            <div>
              <p class="text-xs uppercase text-slate-500">Usuario ID</p>
              <p id="profile-id">‚Äî</p>
            </div>
            <div>
              <p class="text-xs uppercase text-slate-500">Creado</p>
              <p id="profile-created">‚Äî</p>
            </div>
          </div>
          <div class="rounded-lg bg-primary/5 border border-primary/10 px-4 py-3 text-sm text-primary" id="welcome-message">
            Te daremos la bienvenida apenas se valide tu sesi√≥n.
          </div>
        </div>
        <div class="card-surface p-5 flex items-center justify-between sm:col-span-2">
          <div class="space-y-1">
            <p class="text-sm text-slate-500">Metodolog√≠a</p>
            <p class="font-semibold">Healthcheck real con token + perfil /me</p>
            <p class="text-xs text-slate-500">Progreso hacia el entregable de autenticaci√≥n y contexto de empresa.</p>
          </div>
          <span class="badge bg-emerald-100 text-emerald-700" id="session-status">Bloqueado</span>
        </div>
        <div class="card-surface p-5 space-y-4 sm:col-span-2" id="documents-panel">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-sm text-slate-500">Repositorio documental</p>
              <h2 class="text-xl font-semibold text-ink">Documentos disponibles</h2>
              <p class="text-xs text-slate-500">Consulta inicial limitada: lista y detalle del primer documento.</p>
            </div>
            <span class="badge bg-amber-100 text-amber-700" id="documents-badge">Protegido</span>
          </div>
          <div class="grid gap-4 md:grid-cols-[1.05fr_0.95fr]">
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <p class="text-sm text-slate-500">Listado (GET /documents)</p>
                <span class="badge bg-slate-100 text-slate-700" id="documents-count">0 docs</span>
              </div>
              <div
                id="documents-list"
                class="space-y-2 max-h-80 overflow-y-auto p-1 border border-slate-200 rounded-xl bg-white"
              >
                <p class="text-sm text-slate-500 px-3 py-2">A la espera de la sesi√≥n activa...</p>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">Detalle (GET /documents/:id)</p>
                  <p class="font-semibold text-ink" id="document-title">Sin documento cargado</p>
                </div>
                <span class="badge bg-slate-100 text-slate-700" id="document-status">‚Äî</span>
              </div>
              <div class="card-surface border border-slate-200 space-y-2" id="document-detail">
                <p class="text-sm text-slate-600" id="document-description">Cuando haya sesi√≥n, cargaremos el primer documento.</p>
                <div class="grid grid-cols-2 gap-3 text-sm text-slate-600">
                  <div>
                    <p class="text-xs uppercase text-slate-500">C√≥digo</p>
                    <p id="document-code">‚Äî</p>
                  </div>
                  <div>
                    <p class="text-xs uppercase text-slate-500">Tipo</p>
                    <p id="document-type">‚Äî</p>
                  </div>
                  <div>
                    <p class="text-xs uppercase text-slate-500">Categor√≠a</p>
                    <p id="document-category">‚Äî</p>
                  </div>
                  <div>
                    <p class="text-xs uppercase text-slate-500">Propietario</p>
                    <p id="document-owner">‚Äî</p>
                  </div>
                  <div>
                    <p class="text-xs uppercase text-slate-500">Versi√≥n actual</p>
                    <p id="document-version">‚Äî</p>
                  </div>
                  <div>
                    <p class="text-xs uppercase text-slate-500">Estado</p>
                    <p id="document-version-status">‚Äî</p>
                  </div>
                </div>
                <div class="space-y-1 text-sm text-slate-600">
                  <p class="text-xs uppercase text-slate-500">Etiquetas</p>
                  <div id="document-tags" class="flex flex-wrap gap-2"></div>
                </div>
                <a
                  id="document-link"
                  class="button-secondary inline-flex justify-center items-center gap-2 w-full"
                  href="#"
                  target="_blank"
                  rel="noreferrer"
                >
                  Abrir recurso externo
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <LoginForm client:load />
  </div>

  <script type="module">
    import { fetchProfile, logout } from "../services/auth";
    import { fetchDocumentDetail, fetchDocuments } from "../services/documents";

    const ACCESS_TOKEN_KEY = "accessToken";
    const PROFILE_STORAGE_KEY = "profile";
    const REFRESH_TOKEN_KEY = "refreshToken";

    const overlay = document.getElementById("lock-overlay");
    const protectedArea = document.getElementById("protected-area");
    const statusBadge = document.getElementById("session-status");

    const profileName = document.getElementById("profile-name");
    const profileEmail = document.getElementById("profile-email");
    const profileRole = document.getElementById("profile-role");
    const profileCompany = document.getElementById("profile-company");
    const profileId = document.getElementById("profile-id");
    const profileCreated = document.getElementById("profile-created");
    const welcomeMessage = document.getElementById("welcome-message");

    const documentsBadge = document.getElementById("documents-badge");
    const documentsCount = document.getElementById("documents-count");
    const documentsList = document.getElementById("documents-list");
    const documentTitle = document.getElementById("document-title");
    const documentDescription = document.getElementById("document-description");
    const documentCode = document.getElementById("document-code");
    const documentType = document.getElementById("document-type");
    const documentCategory = document.getElementById("document-category");
    const documentOwner = document.getElementById("document-owner");
    const documentVersion = document.getElementById("document-version");
    const documentVersionStatus = document.getElementById("document-version-status");
    const documentStatus = document.getElementById("document-status");
    const documentTags = document.getElementById("document-tags");
    const documentLink = document.getElementById("document-link");

    const profileEndpoint = protectedArea?.dataset.profileEndpoint;
    const logoutEndpoint = protectedArea?.dataset.logoutEndpoint;
    const documentsEndpoint = protectedArea?.dataset.documentsEndpoint;
    const logoutButton = document.getElementById("logout-button");
    let documentsLoaded = false;

    let swalPromise;

    const loadSwal = async () => {
      if (!swalPromise) {
        swalPromise = import("https://cdn.jsdelivr.net/npm/sweetalert2@11");
      }
      const module = await swalPromise;
      return module.default;
    };

    const showAlert = async ({ title, text, icon = "info" }) => {
      try {
        const Swal = await loadSwal();
        await Swal.fire({
          title,
          text,
          icon,
          confirmButtonColor: "#2563eb",
        });
      } catch (error) {
        console.error("No se pudo mostrar SweetAlert2", error);
        alert(`${title}: ${text}`);
      }
    };

    const redirectToLogin = () => {
      window.location.href = "/login";
    };

    const clearSession = () => {
      localStorage.removeItem(ACCESS_TOKEN_KEY);
      localStorage.removeItem(REFRESH_TOKEN_KEY);
      localStorage.removeItem(PROFILE_STORAGE_KEY);
    };

    const lockContent = () => {
      overlay?.classList.remove("hidden");
      protectedArea?.classList.add("pointer-events-none", "opacity-80");
      if (statusBadge) {
        statusBadge.textContent = "Bloqueado";
        statusBadge.className = "badge bg-amber-100 text-amber-700";
      }
      setDocumentsBadge("Protegido", "neutral");
    };

    const unlockContent = () => {
      overlay?.classList.add("hidden");
      protectedArea?.classList.remove("pointer-events-none", "opacity-80");
      if (statusBadge) {
        statusBadge.textContent = "Sesi√≥n activa";
        statusBadge.className = "badge bg-emerald-100 text-emerald-700";
      }
    };

    const renderWelcome = (profile) => {
      if (!welcomeMessage || !profile) return;
      welcomeMessage.textContent = `Bienvenido ${profile.full_name || "usuario"} Ì±ã. El panel ya est√° desbloqueado.`;
    };

    const renderProfile = (profile) => {
      if (!profile) return;
      profileName && (profileName.textContent = profile.full_name || "Usuario");
      profileEmail && (profileEmail.textContent = profile.email);
      profileRole && (profileRole.textContent = profile.role ?? "auth");
      profileCompany && (profileCompany.textContent = profile.company_id);
      profileId && (profileId.textContent = profile.id);
      profileCreated && (profileCreated.textContent = new Date(profile.created_at).toLocaleString());
      renderWelcome(profile);
    };

    const setDocumentsBadge = (text, variant = "neutral") => {
      if (!documentsBadge) return;
      const base = "badge ";
      const variants = {
        neutral: `${base}bg-amber-100 text-amber-700`,
        success: `${base}bg-emerald-100 text-emerald-700`,
        error: `${base}bg-red-100 text-red-700`,
        pending: `${base}bg-blue-100 text-blue-700`,
      };
      documentsBadge.textContent = text;
      documentsBadge.className = variants[variant] || variants.neutral;
    };

    const renderTags = (tags = []) => {
      if (!documentTags) return;
      documentTags.innerHTML = "";
      if (!tags.length) {
        documentTags.innerHTML = '<span class="text-xs text-slate-500">Sin etiquetas</span>';
        return;
      }
      tags.forEach((tag) => {
        const badge = document.createElement("span");
        badge.className = "badge bg-slate-100 text-slate-700";
        badge.textContent = tag;
        documentTags.appendChild(badge);
      });
    };

    const renderDocumentDetail = (document) => {
      if (!documentTitle || !documentStatus) return;

      if (!document) {
        documentTitle.textContent = "Sin documento cargado";
        documentDescription && (documentDescription.textContent = "Todav√≠a no se ha podido obtener informaci√≥n.");
        documentCode && (documentCode.textContent = "‚Äî");
        documentType && (documentType.textContent = "‚Äî");
        documentCategory && (documentCategory.textContent = "‚Äî");
        documentOwner && (documentOwner.textContent = "‚Äî");
        documentVersion && (documentVersion.textContent = "‚Äî");
        documentVersionStatus && (documentVersionStatus.textContent = "‚Äî");
        documentStatus.textContent = "‚Äî";
        documentStatus.className = "badge bg-slate-100 text-slate-700";
        renderTags([]);
        if (documentLink) {
          documentLink.href = "#";
          documentLink.classList.add("opacity-60", "pointer-events-none");
        }
        return;
      }

      const currentVersion = document.currentVersion;
      const externalUrl = currentVersion?.external_url || currentVersion?.file_url;

      documentTitle.textContent = document.title || "Documento";
      documentDescription &&
        (documentDescription.textContent = document.description || "Documento sin descripci√≥n disponible en la API.");
      documentCode && (documentCode.textContent = document.code || "‚Äî");
      documentType && (documentType.textContent = document.type || "‚Äî");
      documentCategory && (documentCategory.textContent = document.category || "‚Äî");
      documentOwner && (documentOwner.textContent = document.owner || "‚Äî");
      documentVersion && (documentVersion.textContent = currentVersion?.version || "Sin versi√≥n");
      documentVersionStatus && (documentVersionStatus.textContent = currentVersion?.status || "‚Äî");

      documentStatus.textContent = document.active ? "Activo" : "Inactivo";
      documentStatus.className = document.active
        ? "badge bg-emerald-100 text-emerald-700"
        : "badge bg-slate-200 text-slate-700";

      renderTags(document.tags || []);

      if (documentLink) {
        if (externalUrl) {
          documentLink.href = externalUrl;
          documentLink.classList.remove("opacity-60", "pointer-events-none");
        } else {
          documentLink.href = "#";
          documentLink.classList.add("opacity-60", "pointer-events-none");
        }
      }
    };

    const renderDocumentsList = (documents = [], token) => {
      if (!documentsList || !documentsCount) return;
      documentsList.innerHTML = "";
      documentsCount.textContent = `${documents.length} docs`;

      if (!documents.length) {
        documentsList.innerHTML = '<p class="text-sm text-slate-500 px-3 py-2">Sin documentos disponibles.</p>';
        renderDocumentDetail(null);
        return;
      }

      documents.forEach((doc, index) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className =
          "w-full text-left px-3 py-3 rounded-lg border border-slate-200 hover:border-primary/60 hover:bg-primary/5 transition-colors";
        button.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="font-semibold text-ink">${doc.title}</p>
              <p class="text-xs text-slate-500">${doc.code}</p>
            </div>
            <span class="badge bg-slate-100 text-slate-700">${doc.currentVersion?.version || "Sin versi√≥n"}</span>
          </div>
          <p class="text-xs text-slate-600 mt-1 line-clamp-2">${doc.description || "Documento sin descripci√≥n"}</p>
        `;

        button.addEventListener("click", () => {
          if (token) {
            loadDocumentDetail(doc.id, token);
          }
        });

        if (index === 0) {
          button.classList.add("border-primary/60", "bg-primary/5");
        }

        documentsList.appendChild(button);
      });
    };

    const loadDocumentDetail = async (documentId, token) => {
      if (!documentId || !documentsEndpoint) return;
      setDocumentsBadge("Detalle", "pending");

      try {
        const detailEndpoint = `${documentsEndpoint}/${documentId}`;
        const { data } = await fetchDocumentDetail(detailEndpoint, token);
        renderDocumentDetail(data);
        setDocumentsBadge("Sincronizado", "success");
      } catch (error) {
        const message = error instanceof Error ? error.message : "No se pudo obtener el documento";
        await showAlert({
          title: "Error al cargar el documento",
          text: message,
          icon: "error",
        });
        setDocumentsBadge("Error", "error");
      }
    };

    const loadDocuments = async (token) => {
      if (!documentsEndpoint || !token) return;
      setDocumentsBadge("Cargando", "pending");
      documentsCount && (documentsCount.textContent = "0 docs");
      documentsLoaded = false;

      try {
        const { data } = await fetchDocuments(documentsEndpoint, token);
        renderDocumentsList(data, token);
        if (data?.length) {
          await loadDocumentDetail(data[0].id, token);
        }
        setDocumentsBadge("Disponible", "success");
        documentsLoaded = true;
      } catch (error) {
        const message = error instanceof Error ? error.message : "No se pudo obtener los documentos";
        await showAlert({
          title: "No se pudo obtener el listado",
          text: message,
          icon: "error",
        });
        renderDocumentDetail(null);
        setDocumentsBadge("Error", "error");
      }
    };

    const onSessionReady = async (profile, token) => {
      renderProfile(profile);
      unlockContent();
      if (token && !documentsLoaded) {
        await loadDocuments(token);
      }
    };

    const loadProfileFromServer = async (token) => {
      if (!token || !profileEndpoint) return null;
      const response = await fetchProfile(profileEndpoint, token);
      localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(response.data));
      return response.data;
    };

    const hydrateFromLocal = () => {
      const cachedProfile = localStorage.getItem(PROFILE_STORAGE_KEY);
      if (cachedProfile) {
        try {
          return JSON.parse(cachedProfile);
        } catch (error) {
          console.error("No se pudo parsear el perfil en cach√©", error);
        }
      }
      return null;
    };

    const checkSession = async () => {
      const token = localStorage.getItem(ACCESS_TOKEN_KEY);
      if (!token) {
        redirectToLogin();
        return;
      }

      const cachedProfile = hydrateFromLocal();
      if (cachedProfile) {
        await onSessionReady(cachedProfile, token);
      }

      try {
        const profile = await loadProfileFromServer(token);
        if (profile) {
          await onSessionReady(profile, token);
        }
      } catch (error) {
        console.error("Sesi√≥n inv√°lida", error);
        const message = error instanceof Error ? error.message : "No se pudo validar la sesi√≥n";
        await showAlert({
          title: "Sesi√≥n expirada",
          text: message,
          icon: "error",
        });
        clearSession();
        lockContent();
        redirectToLogin();
      }
    };

    window.addEventListener("session:login", async (event) => {
      const detail = event.detail || {};
      if (detail.profile) {
        await onSessionReady(detail.profile, detail.accessToken);
      }

      if (detail.accessToken) {
        try {
          const refreshedProfile = await loadProfileFromServer(detail.accessToken);
          if (refreshedProfile) {
            await onSessionReady(refreshedProfile, detail.accessToken);
          }
        } catch (error) {
          console.error("No se pudo refrescar el perfil tras login", error);
        }
      }
    });

    const handleLogout = async () => {
      if (!logoutButton) return;
      const token = localStorage.getItem(ACCESS_TOKEN_KEY);

      if (!token) {
        clearSession();
        redirectToLogin();
        return;
      }

      if (!logoutEndpoint) {
        console.error("No se configur√≥ el endpoint de logout");
        clearSession();
        redirectToLogin();
        return;
      }

      logoutButton.disabled = true;
      logoutButton.textContent = "Cerrando sesi√≥n...";

      try {
        await logout(logoutEndpoint, token);
      } catch (error) {
        console.error("No se pudo cerrar sesi√≥n", error);
        const message = error instanceof Error ? error.message : "No se pudo cerrar sesi√≥n";
        await showAlert({
          title: "Cierre de sesi√≥n incompleto",
          text: message,
          icon: "warning",
        });
      } finally {
        clearSession();
        redirectToLogin();
      }
    };

    logoutButton?.addEventListener("click", handleLogout);

    checkSession();
  </script>
</Layout>
